<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>IPTV Player desde M3U remota</title>
  <link href="https://vjs.zencdn.net/7.20.3/video-js.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script src="https://vjs.zencdn.net/7.20.3/video.min.js"></script>
  <style>
    #channelList {
      max-height: 300px;
      overflow-y: scroll;
      border: 1px solid #ccc;
      margin-bottom: 1em;
    }
    #channelList button {
      display: block;
      width: 100%;
      padding: 8px;
      text-align: left;
      border: none;
      background: #eee;
      margin-bottom: 2px;
      cursor: pointer;
    }
    #channelList button:hover {
      background: #ddd;
    }
  </style>
</head>
<body>

  <h2>IPTV Player - Lista remota M3U</h2>
  <div id="channelList">Cargando canales...</div>

  <video id="video" class="video-js vjs-default-skin" controls width="640" height="360"></video>

  <script>
    const video = document.getElementById('video');
    const player = videojs(video);
    let hls;

    async function fetchM3U(url) {
      const res = await fetch(url);
      if (!res.ok) throw new Error('Error al descargar lista M3U');
      const text = await res.text();
      return text;
    }

    // Parsear lista M3U simple (extrae nombre y URL)
    function parseM3U(data) {
      const lines = data.split('\n');
      const channels = [];
      for (let i = 0; i < lines.length; i++) {
        if (lines[i].startsWith('#EXTINF')) {
          // Extraer nombre despuÃ©s de la coma
          const name = lines[i].split(',')[1]?.trim() || 'Sin nombre';
          const url = lines[i+1]?.trim();
          if (url && !url.startsWith('#')) {
            channels.push({name, url});
          }
        }
      }
      return channels;
    }

    function loadStream(url) {
      if (hls) {
        hls.destroy();
        hls = null;
      }

      if (Hls.isSupported()) {
        hls = new Hls();
        hls.loadSource(url);
        hls.attachMedia(video);
        hls.on(Hls.Events.MANIFEST_PARSED, function() {
          video.play();
        });
      } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
        video.src = url;
        video.play();
      } else {
        alert('Tu navegador no soporta HLS');
      }
    }

    async function init() {
      const url = 'https://raw.githubusercontent.com/alancedano2/mediaiptv/refs/heads/main/m3u4u-132699-650521-Playlist.m3u';
      try {
        const m3uText = await fetchM3U(url);
        const channels = parseM3U(m3uText);

        const listDiv = document.getElementById('channelList');
        listDiv.innerHTML = '';

        channels.forEach((ch, i) => {
          const btn = document.createElement('button');
          btn.textContent = ch.name;
          btn.onclick = () => loadStream(ch.url);
          listDiv.appendChild(btn);
        });

        if (channels.length > 0) {
          loadStream(channels[0].url);
        }
      } catch(e) {
        document.getElementById('channelList').textContent = 'Error cargando canales: ' + e.message;
      }
    }

    init();
  </script>

</body>
</html>
