<!DOCTYPE html>
<html>
<head>
    <title>Radio Player con Proxy</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        /* (Tus mismos estilos CSS) */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f5;
            color: #1c1e21;
            display: grid;
            place-items: center;
            min-height: 100vh;
            margin: 0;
        }
        .player-card {
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 24px;
            width: 90%;
            max-width: 400px;
            text-align: center;
        }
        audio {
            width: 100%;
            margin-bottom: 20px;
        }
        #metadataDisplay {
            font-size: 1.1em;
            font-weight: 600;
            color: #050505;
            min-height: 50px;
            display: grid;
            place-items: center;
            background-color: #f0f2f5;
            padding: 10px;
            border-radius: 6px;
        }
        #metadataDisplay p {
            margin: 0;
        }
        #metadataDisplay .label {
            font-size: 0.8em;
            font-weight: normal;
            color: #65676b;
        }
    </style>
</head>
<body>

    <div class="player-card">
        <h2>KQ 105 Player</h2>
        <audio id="radioPlayer" controls></audio>
        <div id="metadataDisplay">
            <p>Cargando metadata...</p>
        </div>
    </div>

    <script>
        // URL del Audio (Esto SÍ funciona directo con HLS.js)
        var streamUrl = 'https://televicentro.streamguys1.com/wkaqfm/playlist.m3u8?key=96bc32e12ecb6b1bafd065de263d64235ff13cc93b57ff806196d3ecd0891325&aw_0_1st.playerId=kq105&source=kq105.com&us_privacy=1YNY&clientType=web&callLetters=WKAQ-FM&devicename=web-desktop&stationid=1846&dist=kq105.com&subscription_type=free&aw_0_1st.version=1.0_html5&aw_0_1st.playerid=kq105_floating_player';
        
        // ¡URL DE TU PROPIO PROXY!
        var proxyUrl = '/api/radio'; 

        var audioPlayer = document.getElementById('radioPlayer');
        var metadataDiv = document.getElementById('metadataDisplay');

        // --- TAREA 1: REPRODUCIR EL AUDIO (Sin cambios) ---
        if (Hls.isSupported()) {
            var hls = new Hls();
            hls.loadSource(streamUrl);
            hls.attachMedia(audioPlayer);
            hls.on(Hls.Events.MANIFEST_PARSED, function() {
                audioPlayer.play(); 
            });
        } else if (audioPlayer.canPlayType('application/vnd.apple.mpegurl')) {
            audioPlayer.src = streamUrl;
        }

        // --- TAREA 2: BUSCAR LA METADATA (Llamando al Proxy) ---
        
        let currentSong = ""; 

        async function fetchMetadataFromProxy() {
            console.log("Buscando metadata desde el proxy...", proxyUrl);
            try {
                // ¡AQUÍ ESTÁ EL CAMBIO!
                // Llamamos a nuestro propio proxy, que no tiene CORS
                const response = await fetch(proxyUrl, { cache: 'no-store' });
                const data = await response.json(); // Recibimos el JSON

                const artist = data.artist;
                const title = data.title;
                const songId = (artist || "") + " - " + (title || "");
                
                console.log("Metadata recibida:", songId);

                if (songId !== currentSong && songId.trim() !== "-") {
                    currentSong = songId;
                    console.log("¡ACTUALIZANDO HTML! Nueva canción:", currentSong);
                    
                    if (artist && title) {
                        metadataDiv.innerHTML = `
                            <p class="label">ARTISTA:</p>
                            <p>${artist}</p>
                            <p class="label" style="margin-top: 8px;">CANCIÓN:</p>
                            <p>${title}</p>
                        `;
                    } else if (title) {
                        metadataDiv.innerHTML = `<p>${title}</p>`;
                    }
                }
            } catch (error) {
                console.error('Error buscando metadata del proxy:', error);
                metadataDiv.innerHTML = "<p>Error al cargar metadata.</p>";
            }
        }

        fetchMetadataFromProxy();
        setInterval(fetchMetadataFromProxy, 10000); 

    </script>

</body>
</html>
